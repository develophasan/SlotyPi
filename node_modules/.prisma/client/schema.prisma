generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  piUid     String   @unique
  username  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ledgerEntries LedgerEntry[]
  payments      Payment[]
}

model Payment {
  id          String  @id @default(cuid())
  piPaymentId String  @unique
  direction   String // "user_to_app" | "app_to_user"
  network     String // "Pi Network" | "Pi Testnet"
  amountPi    Float
  txid        String?

  statusDeveloperApproved   Boolean @default(false)
  statusTransactionVerified Boolean @default(false)
  statusDeveloperCompleted  Boolean @default(false)
  statusCancelled           Boolean @default(false)
  statusUserCancelled       Boolean @default(false)

  memo     String
  metadata String // JSON.stringify(dto.metadata)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  creditedLedgerEntryId String?      @unique
  creditedLedgerEntry   LedgerEntry? @relation("PaymentCreditedLedgerEntry", fields: [creditedLedgerEntryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LedgerEntry {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  type          String // DEPOSIT_CREDIT, BET, PAYOUT, AD_REWARD, ADJUSTMENT
  amountCredits Int // signed integer
  refType       String? // "pi_payment" | "spin" | "admin" | ...
  refId         String? // paymentId, spinId, etc.
  meta          String? // JSON.stringify(...)

  createdAt DateTime @default(now())

  // Back-reference for credited payment
  creditedByPayment Payment? @relation("PaymentCreditedLedgerEntry")

  @@unique([refType, refId, type])
  @@index([userId, createdAt])
}
